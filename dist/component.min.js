!function(e,t){"function"==typeof define&&define.amd?define(["cargo.Model","cargo.Translation","virtualDom","html2hscript","Handlebars","superagent"],t):"object"==typeof exports?module.exports=t(require("cargo.Model"),require("cargo.Translation"),require("virtualDom"),require("html2hscript"),require("Handlebars"),require("superagent")):(e.cargo=e.cargo||{},e.cargo.Component=t(e.cargo.Model,e.cargo.Translation,e.virtualDom,e.html2hscript,e.Handlebars,e.superagent))}(this,function(Model,Translation,virtualDom,html2hscript,Handlebars,superagent){var Component=function(e,t){"use strict";function r(e,t){return n?new Promise(function(e){var r={};r.template=t.compile(n.template),r.handlebars=t;var o=["attach","update","detach"];_.each(o,function(e){r[e]=n[e]}),e(r)}):new Promise(function(r,a){superagent.get(e).end(function(i,s){if(i)return void a(new Error("Unable to load template from '"+e+"': "+i));var c;try{var l=new DOMParser,h=l.parseFromString(s.text,"text/html");if(c=o(h).find("template").first(),!c||!c.length)return void a(new Error("Template '"+e+"' does not contain a <template> element in body."));n={},n.template=c.html().trim(),c=t.compile(n.template)}catch(d){return void a(new Error("Unable to compile rendering function from template '"+e+"': "+d))}var u={};u.template=c,u.handlebars=t;for(var m=["attach","update","detach"],p=0;p<m.length;p++){var f=m[p];try{var g=o(h).find("script."+f).first();if(g.length>0){var v=g.text();n[f]=u[f]=new Function("node",v)}else n[f]=u[f]=new Function("")}catch(d){return void a(new Error("Unable to install '"+f+"' function from template '"+e+"': "+d))}}r(u)})})}if(!Promise)throw new Error("Promise API is required.");if(!Model)throw new Error("cargo.Model API is required.");if(!Translation)throw new Error("cargo.Translation API is required.");if(!virtualDom)throw new Error("Virtual DOM required. (https://github.com/Matt-Esch/virtual-dom)");if(!html2hscript)throw new Error("Module html2hscript required.");if(!superagent)throw new Error("superagent is required. (https://github.com/visionmedia/superagent)");if(!Handlebars)throw new Error("Handlebars is required. (https://github.com/wycats/handlebars.js/)");if(!_)throw new Error("underscore is required. (https://github.com/jashkenas/underscore)");var o=window.$;t=t||{};var a=t.handlebars||Handlebars,n=void 0;return this.attach=function(t){if(!t)return Promise.reject(new Error("Need a jquery selector as first argument to attach()."));var n=o(t),i={};if(!n||0==n.length)return Promise.reject(new Error("Selector "+t+" does not select any actual DOM nodes."));try{n.each(function(e,r){var a=o(r),n=a.attr("x-cargo-id");if(n)throw new Error("Node "+r.toString()+" selected by "+t+" has already been attached to a component.");var s=_.uniqueId();a.attr("x-cargo-id",s),i[s]=r})}catch(s){return Promise.reject(s)}return r(e,a).then(function(e){var r=new Renderer(t,i,e);return Promise.resolve(r)})},this};Component.prototype.constructor=Component;var Renderer=function(selector,originalNodes,template){var h=virtualDom.h,target=$(),tree=void 0,templateFn=template.template,attach=template.attach,update=template.update,detach=template.detach;this.detach=function(){_.each(originalNodes,function(e,t){e.removeAttribute("x-cargo-id"),target&&target.length&&target.each(function(){if(this.getAttribute("x-cargo-id")===t){try{detach&&detach(this)}catch(r){}$(this).replaceWith(e)}})}),originalNodes={},target=$(),tree=void 0},this.render=function(state){if(state=Model.state(state),void 0===state)return Promise.resolve(state);if(state instanceof Error)return Promise.reject(state);if(!selector||!_.keys(originalNodes).length)return Promise.resolve(state);this.state=state.toJS();var html=templateFn(this.state);if(!html)return Promise.resolve(state);var newTree=void 0;return html2hscript(html,function(err,hscript){newTree=eval(hscript),err&&console.log("Rendering error: "+err)}),newTree||console.log("Rendering did not return a result."),void 0===tree?_.each(originalNodes,function(e,t){var r=virtualDom.create(newTree),o=$(e);try{var a=o.prop("id");a&&(r.id=a),r.setAttribute("x-cargo-id",t),o.replaceWith(r),attach.call(this,r),target=target.add(r)}catch(n){console.log("Error while calling attach() on component with selector: "+self.selector)}try{update.call(this,r)}catch(n){console.log("Error while calling update() on component with selector: "+self.selector)}},this):target.each(function(){var e=virtualDom.diff(tree,newTree);virtualDom.patch(this,e);try{update.call(this)}catch(t){console.log("Error while calling update() on component with selector: "+self.selector)}}),tree=newTree,Promise.resolve(state)},this.refresh=function(){return this.render(this.state)}};return Renderer.prototype.constructor=Renderer,Component.Renderer=Renderer,Component});