!function(e,t){"function"==typeof define&&define.amd?define(["cargo.Promise","cargo.Model","virtualDom","html2hscript","Handlebars","superagent"],t):"object"==typeof exports?module.exports=t(require("cargo.Promise"),require("cargo.Model"),require("virtualDom"),require("html2hscript"),require("Handlebars"),require("superagent")):(e.cargo=e.cargo||{},e.cargo.Component=t(e.cargo.Promise,e.cargo.Model,e.virtualDom,e.html2hscript,e.Handlebars,e.superagent))}(this,function(Promise,Model,virtualDom,html2hscript,Handlebars,superagent){var Component=function(options){"use strict";var $=window.$;if(!Promise)throw new Error("cargo.Promise API is required.");if(!Model)throw new Error("cargo.Model API is required.");if(!virtualDom)throw new Error("Virtual DOM required. (https://github.com/Matt-Esch/virtual-dom)");if(!html2hscript)throw new Error("Module html2hscript required.");if(!superagent)throw new Error("superagent is required. (https://github.com/visionmedia/superagent)");if(!Handlebars)throw new Error("Handlebars is required. (https://github.com/wycats/handlebars.js/)");var h=virtualDom.h,Renderer=function(selector,model,innerFns,subscriptions){this.selector=selector,this.attach=innerFns.attach.bind(model),this.update=innerFns.update.bind(model),this.detach=innerFns.detach.bind(model),this.template=innerFns.template,this.isDestroyed=!1,this.target=void 0,this.originalNodes=[],this.tree=void 0;var render=function(state){var self=this;if(!self.isDestroyed&&(!self.target||self.target.length)){if(state instanceof Error)return void self.destroy();var html=self.template(state);if(html){var newTree=void 0;if(html2hscript(html,function(err,hscript){newTree=eval(hscript),err&&console.log("Rendering error: "+err)}),newTree||console.log("Rendering did not return a result."),void 0===self.tree){var selection=$();self.target=$(selector),self.target.each(function(){var e=virtualDom.create(newTree),t=$(this);try{var r=t.prop("id");r&&(e.id=r),self.originalNodes.push(t),t.replaceWith(e),self.attach(e),selection=selection.add(e)}catch(n){console.log("Error while calling attach() on component with selector: "+self.selector)}self.target=selection;try{self.update(this)}catch(n){console.log("Error while calling update() on component with selector: "+self.selector)}})}else self.target&&self.target.each(function(){var e=virtualDom.diff(self.tree,newTree);virtualDom.patch(this,e);try{self.update(this)}catch(t){console.log("Error while calling update() on component with selector: "+self.selector)}});self.tree=newTree}}};render=render.bind(this),this.unsubscribes=[],this.unsubscribes.push(model(render));for(var idx=0;idx<subscriptions.length;idx++){var subscr=subscriptions[idx],stateFn=subscr.callback.bind(model);this.unsubscribes.push(subscr.model(stateFn))}this.destroy=function(){var e=this;e.isDestroyed=!0;for(var t=e.unsubscribes||[],r=0;r<t.length;r++)try{t[r]()}catch(n){}e.target.each(function(t){try{e.detach(this)}catch(r){}var n=e.originalNodes[t];$(this).replaceWith(n)})}.bind(this)},_defaultTemplate={attach:function(){},detach:function(){},update:function(){},template:function(e){return'<pre class="_componentState">'+JSON.stringify(e,null,"  ")+"</pre>"}},defaults={template:_defaultTemplate,actions:{},subscriptions:[]};options=options||{},this.options={};for(var prop in defaults)defaults.hasOwnProperty(prop)&&(this.options[prop]=options.hasOwnProperty(prop)?options[prop]:defaults[prop]);return this.withTemplate=function(e){var t={};for(var r in _defaultTemplate)_defaultTemplate.hasOwnProperty(r)&&(t[r]=_defaultTemplate[r]);if(e){if("function"==typeof e){t.template=e;for(var n=["attach","update","detach"],i=0;i<n.length;i++){var o=n[i];e.hasOwnProperty(o)&&"function"==typeof e[o]&&(t[o]=e[o])}}else if("<"==e.toString().trim().charAt(0)){var s=e.toString().trim();t.template=function(){return s}}}else this.options.template=t;return this.options.template=t,this},this.subscribe=function(e,t){if(!e||"function"!=typeof e)throw new Error("Parameter #1 (model) is required and needs to be a function.");if(t){if("function"!=typeof t)throw new Error("Parameter #2 (callback) needs to be a function.")}else t=function(e){return e};return this.options.subscriptions.push({callback:t,model:e}),this},this.withActions=function(e){if(!e)throw new Error("Parameter #1 (actions) is required.");for(var t in e)e.hasOwnProperty(t)&&(this.options.actions[t]=e[t]);return this},this.addAction=function(e,t){if(!e)throw new Error("Parameter #1 (name) is required.");if(t){if("function"!=typeof t)throw new Error("Parameter #2 (action) needs to be a function.");return this.options.actions[e]=t,this}},this.build=function(e){var t=this,r=new Model(t.options.actions),n=new Renderer(e,r,t.options.template,t.options.subscriptions);return r._detach=function(){this.destroy(),console.log("x")}.bind(n),r},this};return Component.template=function(e){return new Promise(function(t,r){superagent.get(e).end(function(n,i){if(n)return void r("Unable to load template from '"+e+"': "+n);try{var o=new DOMParser,s=o.parseFromString(i.text,"text/html"),a=$(s).find("template").first();if(!a||!a.length)return void r("Template '"+e+"' does not contain a <template> element in body.");a=a.html().trim(),a=Handlebars.compile(a)}catch(l){return void r("Unable to install renderer from template '"+e+"': "+l)}var c={};c.template=a;for(var u=["attach","update","detach"],h=0;h<u.length;h++){var d=u[h];try{var p=$(s).find("script."+d).first();if(p.length>0){var f=p.text();c[d]=new Function("node",f),a[d]=new Function("node",f)}else c[d]=new Function(""),a[d]=new Function("")}catch(l){return void r("Unable to install '"+d+"' function from template '"+e+"': "+l)}}t(a)})})},Component});