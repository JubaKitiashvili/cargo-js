!function(e,r){"function"==typeof define&&define.amd?define(["cargo.Model","cargo.Translation","morphdom","Handlebars","superagent"],r):"object"==typeof exports?module.exports=r(require("cargo.Model"),require("cargo.Translation"),require("morphdom"),require("Handlebars"),require("superagent")):(e.cargo=e.cargo||{},e.cargo.Component=r(e.cargo.Model,e.cargo.Translation,e.morphdom,e.Handlebars,e.superagent))}(this,function(e,r,t,o,n){var a=function(a,c){"use strict";function s(e,r,t){return p?new Promise(function(e){var t={};t.template=r.compile(p.template),t.handlebars=r;var o=["attach","update","detach"];_.each(o,function(e){t[e]=p[e]}),e(t)}):new Promise(function(o,a){n.get(e).end(function(n,i){if(n)return void a(new Error("Unable to load template from '"+e+"': "+n));var c;try{var s=new DOMParser,h=s.parseFromString(i.text,"text/html");if(c=l(h).find("template").first(),!c||!c.length)return void a(new Error("Template '"+e+"' does not contain a <template> element in body."));p={},p.template=c.html().trim(),c=r.compile(p.template)}catch(u){return void a(new Error("Unable to compile rendering function from template '"+e+"': "+u))}var d={};d.template=c,d.handlebars=r;for(var m=["attach","update","detach"],f=0;f<m.length;f++){var g=m[f];try{var v=l(h).find("script."+g).first();if(v.length>0){var w=v.text();p[g]=d[g]=new Function("node",w)}else p[g]=d[g]=t[g]}catch(u){return void a(new Error("Unable to install '"+g+"' function from template '"+e+"': "+u))}}o(d)})})}if(!Promise)throw new Error("Promise API is required.");if(!e)throw new Error("cargo.Model API is required.");if(!r)throw new Error("cargo.Translation API is required.");if(!t)throw new Error("morphdom is required. (https://github.com/patrick-steele-idem/morphdom)");if(!n)throw new Error("superagent is required. (https://github.com/visionmedia/superagent)");if(!o)throw new Error("Handlebars is required. (https://github.com/wycats/handlebars.js/)");if(!_)throw new Error("underscore is required. (https://github.com/jashkenas/underscore)");var l=window.$;c=c||{};var h=c.handlebars||o,u=c.attach||function(){},d=c.update||function(){},m=c.detach||function(){},p=void 0;return this.attach=function(e){if(!e)return Promise.reject(new Error("Need a jquery selector as first argument to attach()."));var r=l(e),t={};if(!r||0==r.length)return Promise.reject(new Error("Selector "+e+" does not select any actual DOM nodes."));try{r.each(function(r,o){var n=l(o),a=n.attr("x-cargo-id");if(a)throw new Error("Node "+o.toString()+" selected by "+e+" has already been attached to a component.");var i=_.uniqueId();n.attr("x-cargo-id",i),t[i]=o})}catch(o){return Promise.reject(o)}if(h.templates&&h.templates[a]){var n=new i(e,t,h.templates[a],u,d,m);return Promise.resolve(n)}var c={attach:u,update:d,detach:m};return s(a,h,c).then(function(r){var o=new i(e,t,r.template,r.attach,r.update,r.detach);return Promise.resolve(o)})},this};a.prototype.constructor=a;var i=function(r,o,n,a,i,c){var s=$(),l=!0;this.detach=function(){_.each(o,function(e,r){e.removeAttribute("x-cargo-id"),s&&s.length&&s.each(function(){if(this.getAttribute("x-cargo-id")===r){try{c&&c(this)}catch(t){}$(this).replaceWith(e)}})}),o={},s=$(),l=!0},this.render=function(c){if(c=e.state(c),void 0===c)return Promise.resolve(c);if(c instanceof Error)return Promise.reject(c);if(!r||!_.keys(o).length)return Promise.resolve(c);var h=n(c.toJS());return h?(l?(l=!1,_.each(o,function(e,t){var o=$.parseHTML(h);if(o&&o.length){var n=o[0],c=$(e);try{var l=c.prop("id");l&&(n.id=l),n.setAttribute("x-cargo-id",t),c.replaceWith(n),a.call(this,n),s=s.add(n)}catch(u){console.log("Error while calling attach() on component with selector: "+r+": "+u)}try{i.call(this,n)}catch(u){console.log("Error while calling update() on component with selector: "+r+": "+u)}}},this)):s.each(function(){var e=this.id,o=this.getAttribute("x-cargo-id");t(this,h),this.id=e,this.setAttribute("x-cargo-id",o);try{i.call(this)}catch(n){console.log("Error while calling update() on component with selector: "+r+": "+n)}}),Promise.resolve(c)):Promise.resolve(c)}};return i.prototype.constructor=i,a.Renderer=i,a});