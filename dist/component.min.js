!function(e,t){"function"==typeof define&&define.amd?define(["cargo.Promise","cargo.Model","cargo.Translation","virtualDom","html2hscript","Handlebars","superagent"],t):"object"==typeof exports?module.exports=t(require("cargo.Promise"),require("cargo.Model"),require("cargo.Translation"),require("virtualDom"),require("html2hscript"),require("Handlebars"),require("superagent")):(e.cargo=e.cargo||{},e.cargo.Component=t(e.cargo.Promise,e.cargo.Model,e.cargo.Translation,e.virtualDom,e.html2hscript,e.Handlebars,e.superagent))}(this,function(Promise,Model,Translation,virtualDom,html2hscript,Handlebars,superagent){var Component=function(templateURI,options){"use strict";function _loadTemplate(e){return new Promise(function(t,r){superagent.get(e).end(function(n,a){if(n)return void r("Unable to load template from '"+e+"': "+n);var o;try{var i=new DOMParser,s=i.parseFromString(a.text,"text/html");if(o=$(s).find("template").first(),!o||!o.length)return void r("Template '"+e+"' does not contain a <template> element in body.");o=o.html().trim(),o=handlebars.compile(o)}catch(l){return void r("Unable to compile rendering function from template '"+e+"': "+l)}var c={};c.template=o;for(var u=["attach","update","detach"],d=0;d<u.length;d++){var h=u[d];try{var m=$(s).find("script."+h).first();if(m.length>0){var g=m.text();c[h]=new Function("node",g)}else c[h]=new Function("")}catch(l){return void r("Unable to install '"+h+"' function from template '"+e+"': "+l)}}t(c)})})}function _createRenderFn(){var $selector,target=void 0,tree=void 0,originalNodes=[],template,attach,update,detach,_detach=function(){target&&(target.each(function(e){try{detach&&detach(this)}catch(t){}var r=originalNodes[e];$(this).replaceWith(r)}),originalNodes=[],target=void 0,tree=void 0)},renderFn=function(state){var component=this;if(!template)return new Promise(function(e){templateLoader.then(function(t){template=t.template,attach=t.attach,update=t.update,detach=t.detach,renderFn(state),e(state)})});if(void 0===state)return Promise.resolve(state);if(state instanceof Error)return _detach(),Promise.reject(state);if(state.get("selector")!==$selector&&(_detach(),$selector=state.get("selector")),!$selector||target&&0==target.length)return Promise.resolve(state);var html=template(state.toJS());if(!html)return Promise.resolve(state);var newTree=void 0;if(html2hscript(html,function(err,hscript){newTree=eval(hscript),err&&console.log("Rendering error: "+err)}),newTree||console.log("Rendering did not return a result."),void 0===tree){var selection=$();originalNodes=[],$($selector).each(function(){var e=virtualDom.create(newTree),t=$(this);try{var r=t.prop("id");r&&(e.id=r),originalNodes.push(t),t.replaceWith(e),attach(e),selection=selection.add(e)}catch(n){console.log("Error while calling attach() on component with selector: "+self.selector)}target=selection;try{update(this)}catch(n){console.log("Error while calling update() on component with selector: "+self.selector)}})}else target&&target.each(function(){var e=virtualDom.diff(tree,newTree);virtualDom.patch(this,e);try{update(this)}catch(t){console.log("Error while calling update() on component with selector: "+self.selector)}});return tree=newTree,Promise.resolve(state)};return renderFn}function _mergeTranslationStream(){handlebars=translation.getHandlebars();var e=e.merge(translation.asStream(),function(e,t){if(t.has("translations")&&!t.get("loading")){var r=t.get("locales").toJS(),n=t.get("namespaces").toJS();if(r&&n){var a=_.chain(r).uniq().reduce(function(e,r){return t.get("translations").has(r)&&(e=_.chain(n).uniq().reduce(function(e,a){if(t.get("translations").get(r).has(a)){var o=t.get("translations").get(r).get(a),i=o.keys();e=_.chain(i).reduce(function(e,t){return 1==n.length?e[t]=e[t]||o.get(t):(e[a]=e[a]||{},e[a][t]=e[a][t]||o.get(t)),e},e).value()}return e},e).value()),e},{}).value();return e.put("i18n",a)}}})}if(!Promise)throw new Error("cargo.Promise API is required.");if(!Model)throw new Error("cargo.Model API is required.");if(!Translation)throw new Error("cargo.Translation API is required.");if(!virtualDom)throw new Error("Virtual DOM required. (https://github.com/Matt-Esch/virtual-dom)");if(!html2hscript)throw new Error("Module html2hscript required.");if(!superagent)throw new Error("superagent is required. (https://github.com/visionmedia/superagent)");if(!Handlebars)throw new Error("Handlebars is required. (https://github.com/wycats/handlebars.js/)");var $=window.$,h=virtualDom.h;options=options||{};var actions={init:function(){return{visible:!0}},show:function(){return this.state().put("visible",!0)},hide:function(){return this.state().put("visible",!1)},attach:function(e){return this.state().put("selector",e)},detach:function(){return this.state().remove("selector")},destroy:function(t){return e instanceof Error?console.log("Error in component "+templateURI+": "+e.message+"\n"+e.stack):console.log("Error in component "+templateURI+": "+e),t instanceof Error?t:new Error(t)}};actions=options.extendModel?extendModel(actions):actions;var translation=options.translation,handlebars;translation?(handlebars=translation.getHandlebars(),actions.changeLanguage=function(e){return this.state().put("lang",e)},translation.subscribe(function(e){e&&model.changeLanguage(e.get("lang"))})):(handlebars=options.handlebars||Handlebars,handlebars.helpers.i18n||handlebars.registerHelper("i18n",function(){switch(arguments.length){case 0:case 1:return"";case 2:return arguments[0];default:return arguments[1]+"."+arguments[0]}}));var model=new Model(actions),templateLoader=_loadTemplate(templateURI),renderFn=_.bind(_createRenderFn(),this);return templateLoader["catch"](function(e){model.destroy(e)}),this.hide=function(){return model.hide().then(function(e){return renderFn(e)})},this.show=function(){return model.show().then(function(e){return renderFn(e)})},this.getModel=function(){return model},this.attach=function(e){return model.attach(e).then(function(e){return renderFn(e)})},this.detach=function(){return model.detach().then(function(e){return renderFn(e)})},model.init(),this};return Component});