!function(e,t){"function"==typeof define&&define.amd?define(["cargo.Promise","cargo.Model","cargo.Translation","virtualDom","html2hscript","Handlebars","superagent"],t):"object"==typeof exports?module.exports=t(require("cargo.Promise"),require("cargo.Model"),require("cargo.Translation"),require("virtualDom"),require("html2hscript"),require("Handlebars"),require("superagent")):(e.cargo=e.cargo||{},e.cargo.Component=t(e.cargo.Promise,e.cargo.Model,e.cargo.Translation,e.virtualDom,e.html2hscript,e.Handlebars,e.superagent))}(this,function(Promise,Model,Translation,virtualDom,html2hscript,Handlebars,superagent){var Component=function(templateURI,options){"use strict";function _loadTemplate(e,t){return new Promise(templateCache?function(e){var r={};r.template=t.compile(templateCache.template),r.handlebars=t;var a=["attach","update","detach"];_.each(a,function(e){r[e]=templateCache[e]}),e(r)}:function(r,a){superagent.get(e).end(function(o,n){if(o)return void a("Unable to load template from '"+e+"': "+o);var i;try{var l=new DOMParser,c=l.parseFromString(n.text,"text/html");if(i=$(c).find("template").first(),!i||!i.length)return void a("Template '"+e+"' does not contain a <template> element in body.");templateCache={},templateCache.template=i.html().trim(),i=t.compile(templateCache.template)}catch(s){return void a("Unable to compile rendering function from template '"+e+"': "+s)}var h={};h.template=i,h.handlebars=t;for(var d=["attach","update","detach"],u=0;u<d.length;u++){var m=d[u];try{var p=$(c).find("script."+m).first();if(p.length>0){var g=p.text();templateCache[m]=h[m]=new Function("node",g)}else templateCache[m]=h[m]=new Function("")}catch(s){return void a("Unable to install '"+m+"' function from template '"+e+"': "+s)}}r(h)})})}function _createRenderFn(selector,originalNodes,template){var target=$(),tree=void 0,templateFn=template.template,attach=template.attach,update=template.update,detach=template.detach,_detach=function(){_.each(originalNodes,function(e,t){e.removeAttribute("x-cargo-id"),target&&target.length&&target.each(function(){if(this.getAttribute("x-cargo-id")===t){try{detach&&detach(this)}catch(r){}$(this).replaceWith(e)}})}),originalNodes={},target=$(),tree=void 0},renderFn=function(state){var component=this;if(state=Model.state(state),void 0===state)return Promise.resolve(state);if(state instanceof Error)return Promise.reject(state);if(!selector||!_.keys(originalNodes).length)return Promise.resolve(state);var html=templateFn(state.toJS());if(!html)return Promise.resolve(state);var newTree=void 0;return html2hscript(html,function(err,hscript){newTree=eval(hscript),err&&console.log("Rendering error: "+err)}),newTree||console.log("Rendering did not return a result."),void 0===tree?_.each(originalNodes,function(e,t){var r=virtualDom.create(newTree),a=$(e);try{var o=a.prop("id");o&&(r.id=o),r.setAttribute("x-cargo-id",t),a.replaceWith(r),attach(r),target=target.add(r)}catch(n){console.log("Error while calling attach() on component with selector: "+self.selector)}try{update(this)}catch(n){console.log("Error while calling update() on component with selector: "+self.selector)}}):target.each(function(){var e=virtualDom.diff(tree,newTree);virtualDom.patch(this,e);try{update(this)}catch(t){console.log("Error while calling update() on component with selector: "+self.selector)}}),tree=newTree,Promise.resolve(state)};return renderFn.detach=_detach,renderFn}if(!Promise)throw new Error("Promise API is required.");if(!Model)throw new Error("cargo.Model API is required.");if(!Translation)throw new Error("cargo.Translation API is required.");if(!virtualDom)throw new Error("Virtual DOM required. (https://github.com/Matt-Esch/virtual-dom)");if(!html2hscript)throw new Error("Module html2hscript required.");if(!superagent)throw new Error("superagent is required. (https://github.com/visionmedia/superagent)");if(!Handlebars)throw new Error("Handlebars is required. (https://github.com/wycats/handlebars.js/)");if(!_)throw new Error("underscore is required. (https://github.com/jashkenas/underscore)");var $=window.$,h=virtualDom.h;options=options||{};var handlebars=options.handlebars||Handlebars,templateCache=void 0;return this.attach=function(e){if(!e)return Promise.reject("Need a jquery selector as first argument to attach().");var t=$(e),r={};if(!t||0==t.length)return Promise.reject("Selector "+e+" does not select any actual DOM nodes.");try{t.each(function(t,a){var o=$(a),n=o.attr("x-cargo-id");if(n)throw new Error("Node "+a.toString()+" selected by "+e+" has already been attached to a component.");var i=_.uniqueId();o.attr("x-cargo-id",i),r[i]=a})}catch(a){return Promise.reject(a)}return _loadTemplate(templateURI,handlebars).then(function(t){var a=_createRenderFn(e,r,t,handlebars);return Promise.resolve(a)})},this};return Component});