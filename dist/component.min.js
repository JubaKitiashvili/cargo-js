!function(e,t){"function"==typeof define&&define.amd?define(["cargo.Promise","cargo.Model","cargo.Translation","virtualDom","html2hscript","Handlebars","superagent"],t):"object"==typeof exports?module.exports=t(require("cargo.Promise"),require("cargo.Model"),require("cargo.Translation"),require("virtualDom"),require("html2hscript"),require("Handlebars"),require("superagent")):(e.cargo=e.cargo||{},e.cargo.Component=t(e.cargo.Promise,e.cargo.Model,e.cargo.Translation,e.virtualDom,e.html2hscript,e.Handlebars,e.superagent))}(this,function(Promise,Model,Translation,virtualDom,html2hscript,Handlebars,superagent){var Component=function(selector,template,actions,options){"use strict";function _registerTranslatorFn(e,t){var r=function(e){return t&&t[e]?t[e]:e};e.unregisterHelper("i18n"),e.registerHelper("i18n",r)}function _loadTemplate(e){return new Promise(function(t,r){superagent.get(e).end(function(n,a){var o=Handlebars.create();if(n)return void r("Unable to load template from '"+e+"': "+n);var i;try{var l=new DOMParser,s=l.parseFromString(a.text,"text/html");if(i=$(s).find("template").first(),!i||!i.length)return void r("Template '"+e+"' does not contain a <template> element in body.");i=i.html().trim(),i=o.compile(i)}catch(c){return void r("Unable to compile rendering function from template '"+e+"': "+c)}var d={};d.template=i,d.handlebars=o;for(var h=["attach","update","detach"],u=0;u<h.length;u++){var m=h[u];try{var p=$(s).find("script."+m).first();if(p.length>0){var g=p.text();d[m]=new Function("node",g)}else d[m]=new Function("")}catch(c){return void r("Unable to install '"+m+"' function from template '"+e+"': "+c)}}t(d)})})}function _createRenderFn(selector,model,templateLoader,translation){var template=void 0,attach=void 0,update=void 0,detach=void 0,handlebars=void 0,isDestroyed=!1,target=void 0,tree=void 0,originalNodes=[];templateLoader.then(function(e){template=e.template,attach=e.attach,update=e.update,detach=e.detach,handlebars=e.handlebars,translation&&handlebars&&translation(function(e){_registerTranslatorFn(handlebars,e),model.changeLanguage(e)})});var renderFn=function(state){if(void 0!==state&&!isDestroyed){if(state instanceof Error)return target&&target.each(function(e){try{detach(this)}catch(t){}var r=originalNodes[e];$(this).replaceWith(r)}),void(isDestroyed=!0);if(!target||target.length){if(!template)return void templateLoader.then(function(){renderFn(state)});var html=template(state);if(html){var newTree=void 0;if(html2hscript(html,function(err,hscript){newTree=eval(hscript),err&&console.log("Rendering error: "+err)}),newTree||console.log("Rendering did not return a result."),void 0===tree){var selection=$();target=$(selector),target.each(function(){var e=virtualDom.create(newTree),t=$(this);try{var r=t.prop("id");r&&(e.id=r),originalNodes.push(t),t.replaceWith(e),attach(e),selection=selection.add(e)}catch(n){console.log("Error while calling attach() on component with selector: "+self.selector)}target=selection;try{update(this)}catch(n){console.log("Error while calling update() on component with selector: "+self.selector)}})}else target&&target.each(function(){var e=virtualDom.diff(tree,newTree);virtualDom.patch(this,e);try{update(this)}catch(t){console.log("Error while calling update() on component with selector: "+self.selector)}});tree=newTree}}}};return renderFn=renderFn.bind(model)}if(!Promise)throw new Error("cargo.Promise API is required.");if(!Model)throw new Error("cargo.Model API is required.");if(!Translation)throw new Error("cargo.Translation API is required.");if(!virtualDom)throw new Error("Virtual DOM required. (https://github.com/Matt-Esch/virtual-dom)");if(!html2hscript)throw new Error("Module html2hscript required.");if(!superagent)throw new Error("superagent is required. (https://github.com/visionmedia/superagent)");if(!Handlebars)throw new Error("Handlebars is required. (https://github.com/wycats/handlebars.js/)");var $=window.$,h=virtualDom.h;options=options||{},actions=actions||{},!actions.changeLanguage&&options.translation&&(actions.changeLanguage=function(e){return this.state({translation:e})});var translation=options.translation,templateLoader=_loadTemplate(template),model=new Model(actions),renderFn=_createRenderFn(selector,model,templateLoader,translation);return model(renderFn),this.getModel=function(){return model},this.hide=function(){return model.hide(),this},this.show=function(){return model.show(),this},model};return Component});