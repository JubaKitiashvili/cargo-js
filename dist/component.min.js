!function(e,t){"function"==typeof define&&define.amd?define(["cargo.Model","cargo.Translation","morphdom","Handlebars","superagent"],t):"object"==typeof exports?module.exports=t(require("cargo.Model"),require("cargo.Translation"),require("morphdom"),require("Handlebars"),require("superagent")):(e.cargo=e.cargo||{},e.cargo.Component=t(e.cargo.Model,e.cargo.Translation,e.morphdom,e.Handlebars,e.superagent))}(this,function(e,t,r,o,n){var a=function(a,c){"use strict";function s(e,t,r){return f?new Promise(function(e){var r={};r.template=t.compile(f.template),r.handlebars=t;var o=["attach","update","detach"];_.each(o,function(e){r[e]=f[e]}),e(r)}):new Promise(function(o,a){n.get(e).end(function(n,i){if(n)return void a(new Error("Unable to load template from '"+e+"': "+n));var c;try{var s=new DOMParser,l=s.parseFromString(i.text,"text/html");if(c=h(l).find("template").first(),!c||!c.length)return void a(new Error("Template '"+e+"' does not contain a <template> element in body."));f={},f.template=c.html().trim(),c=t.compile(f.template)}catch(u){return void a(new Error("Unable to compile rendering function from template '"+e+"': "+u))}var d={};d.template=c,d.handlebars=t;for(var m=["attach","update","detach"],p=0;p<m.length;p++){var g=m[p];try{var v=h(l).find("script."+g).first();if(v.length>0){var w=v.text();f[g]=d[g]=new Function("node",w)}else f[g]=d[g]=r[g]}catch(u){return void a(new Error("Unable to install '"+g+"' function from template '"+e+"': "+u))}}o(d)})})}if(!Promise)throw new Error("Promise API is required.");if(!e)throw new Error("cargo.Model API is required.");if(!t)throw new Error("cargo.Translation API is required.");if(!r)throw new Error("morphdom is required. (https://github.com/patrick-steele-idem/morphdom)");if(!n)throw new Error("superagent is required. (https://github.com/visionmedia/superagent)");if(!o)throw new Error("Handlebars is required. (https://github.com/wycats/handlebars.js/)");if(!_)throw new Error("underscore is required. (https://github.com/jashkenas/underscore)");var h=window.$;c=c||{};var l=c.handlebars||o,u=c.attach||function(){},d=c.update||function(){},m=c.detach||function(){},f=void 0;return this.attach=function(e){if(!e)return Promise.reject(new Error("Need a jquery selector as first argument to attach()."));var t=h(e),r={};if(!t||0==t.length)return Promise.reject(new Error("Selector "+e+" does not select any actual DOM nodes."));try{t.each(function(t,o){var n=h(o),a=n.attr("x-cargo-id");if(a)throw new Error("Node "+o.toString()+" selected by "+e+" has already been attached to a component.");var i=_.uniqueId();n.attr("x-cargo-id",i),r[i]=o})}catch(o){return Promise.reject(o)}if(l.templates&&l.templates[a]){var n=new i(e,r,l.templates[a],u,d,m);return Promise.resolve(n)}var c={attach:u,update:d,detach:m};return s(a,l,c).then(function(t){var o=new i(e,r,t.template,t.attach,t.update,t.detach);return Promise.resolve(o)})},this};a.prototype.constructor=a;var i=function(t,o,n,a,i,c){var s=$(),h=!0;this.detach=function(){_.each(o,function(e,t){e.removeAttribute("x-cargo-id"),s&&s.length&&s.each(function(){if(this.getAttribute("x-cargo-id")===t){try{c&&c(this)}catch(r){}$(this).replaceWith(e)}})}),o={},s=$(),h=!0},this.render=function(c){if(c=e.state(c),void 0===c)return Promise.resolve(c);if(c instanceof Error)return Promise.reject(c);if(!t||!_.keys(o).length)return Promise.resolve(c);this.state=c.toJS();var l=n(this.state);return l?(h?(h=!1,_.each(o,function(e,r){var o=$.parseHTML(l);if(o&&o.length){var n=o[0],c=$(e);try{var h=c.prop("id");h&&(n.id=h),n.setAttribute("x-cargo-id",r),c.replaceWith(n),a.call(this,n),s=s.add(n)}catch(u){console.log("Error while calling attach() on component with selector: "+t+": "+u)}try{i.call(this,n)}catch(u){console.log("Error while calling update() on component with selector: "+t+": "+u)}}},this)):s.each(function(){var e=this.id,o=this.getAttribute("x-cargo-id");r(this,l),this.id=e,this.setAttribute("x-cargo-id",o);try{i.call(this)}catch(n){console.log("Error while calling update() on component with selector: "+t+": "+n)}}),Promise.resolve(c)):Promise.resolve(c)},this.refresh=function(){return this.render(this.state)}};return i.prototype.constructor=i,a.Renderer=i,a});