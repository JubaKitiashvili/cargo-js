!function(t,n){"function"==typeof define&&define.amd?define(["cargo.Promise"],n):"object"==typeof exports?module.exports=n(require("cargo.Promise")):(t.cargo=t.cargo||{},t.cargo.Model=n(t.cargo.Promise))}(this,function(t){var n=function(r){"use strict";if(!t)throw new Error("cargo.Promise API is required.");var i=this,e=void 0,s=1,o={};i=function(n){var r=s++;if(n&&"function"==typeof n){o[r]={subscriber:n};var u=function(t){delete o[t]};return new t(function(t,r){if(void 0!==e&&!(e instanceof Error))try{n.call(void 0,e),t()}catch(i){console.log("Error in new subscriber: "+i),r()}}),u.bind(i,r)}};for(var u in r)if(r.hasOwnProperty(u)){var a=r[u];if("function"==typeof a){var c={state:function(){return e},model:i},f=function(){for(var r=this.actionCtx,i=this.actionFn,s=[],u=0;u<arguments.length;u++)s.push(arguments[u]);var a=function(t,u){if(e instanceof Error)return void u(e);var a;try{a=i.apply(r,s)}catch(c){u(c)}var f=a instanceof Error;if(void 0!==a){null===a?a=n.state({}):f||(a=n.state(a)),e=a;for(var h in o)if(o.hasOwnProperty(h)){var v=o[h].subscriber;try{v.call(void 0,e)}catch(c){console.log("Error in subscriber: "+c),console.trace(c)}}f&&(o=[])}a instanceof Error?u(a):t(a)};return a=a.bind(this),new t(a)},h={actionCtx:c,actionFn:a};i[u]=f.bind(h)}}return i};n.stream=function(t){return new r(t)};var r=function(t){var i,e=new n({"in":function(t){return i=t,t}});return t(function(t){e["in"](t)}),this["in"]=function(t){e["in"](n.state(t))},this.subscribe=function(t){return e(t)},this.out=function(){return i},this.filter=function(t){var i=new n({filter:t});return e(function(t){i.filter(t)}),new r(i)},this.merge=function(t,i){var s,o;i=i||function(t,n){_.extendOwn({},t,n)};var u=new n({updateOurs:function(t){return s=t,i(s,o)},updateTheirs:function(t){return o=t,i(s,o)}});return t(function(t){u.updateTheirs(t)}),e(function(t){u.updateOurs(t)}),new r(u)},this},i=function(t){var r=function(t){if(!_.isArray(t)&&!_.isArguments())throw new TypeError("Unable to initialize State.List from data other types than arrays.");var r=function(){return i.slice()},i=_.map(_.toArray(t),function(t){return n.state(t)});this.$Map=!1,this.$List=!0,this.type=function(){return"LIST"},this.get=function(t){return i[t]},this.size=function(){return i.length},this.add=function(t){return this.insert(this.size()+1,t)},this.remove=function(t){if(0==this.size()||t>this.size())return this;var i=r();return i.splice(t,1),n.state(i)},this.insert=function(t,i){var e=r(),i=n.state(i);return 0>t?t=0:t>this.size()&&(t=this.size()),e.splice(t,0,i),n.state(e)},this.push=function(t){return this.insert(this.size(),t)},this.pop=function(){return this.remove(0)},this.shift=function(){return this.remove(this.size()-1)},this.unshift=function(t){return this.insert(0,t)},this.toJS=function(){return _.map(i,function(t){return t})}},e=function(t){if(!_.isObject(t))throw new TypeError("Unable to initialize State.Map from data other types than object.");var r={};return _.each(Object.getOwnPropertyNames(t),function(i){r[i]=n.state(t[i])}),this.$Map=!0,this.$List=!1,this.type=function(){return"MAP"},this.get=function(t){return r[t]},this.put=function(t,i){var e=_.extend({},r);return e[t]=n.state(i),n.state(e)},this.remove=function(t){if(_.has(r,t)){var i=_.extendOwn({},r);return delete i[t],n.state(i)}return this},this.has=function(t){return _.has(r,t)},this.keys=function(){return _.keys(r)},this.merge=function(t){var e=n.state(t);if(!e instanceof i||!e.$Map)return this;var s=_.extendOwn({},r,t);return n.state(s)},this.toJS=function(){return _.chain(r).keys().reduce(function(t,n){var e=r[n];return e instanceof i&&(e=e.toJS()),t[n]=e,t},{}).value()},this};return _.isArray(t)?(_.extend(this,new r(t)),this):_.isObject(t)?(_.extend(this,new e(t)),this):void 0};return n.state=function(t){return t instanceof i?t:_.isNumber(t)||_.isBoolean(t)||_.isString(t)||_.isNull(t)||_.isUndefined(t)?t:_.isFunction(t)?void 0:_.isArray(t)||_.isObject(t)?new i(t):void 0},n.subscribe=function(t,n){return t(n)},n});