!function(t,n){"function"==typeof define&&define.amd?define([],n):"object"==typeof exports?module.exports=n():(t.cargo=t.cargo||{},t.cargo.Model=n())}(this,function(){var t=function(n){"use strict";if(!Promise)throw new Error("Promise API is required.");var i=this,r=void 0,e=1,s={};i=function(t){var n=e++;if(t&&"function"==typeof t){s[n]={subscriber:t};var o=function(t){delete s[t]};return new Promise(function(n,i){if(void 0!==r&&!(r instanceof Error))try{t.call(void 0,r),n()}catch(e){console.log("Error in new subscriber: "+e),i()}}),o.bind(i,n)}};for(var o in n)if(n.hasOwnProperty(o)){var u=n[o];if("function"==typeof u){var c={state:function(){return void 0!=r?r:t.state({})},model:i},a=function(){for(var n=this.actionCtx,i=this.actionFn,e=[],o=0;o<arguments.length;o++)e.push(arguments[o]);var u=function(o,u){if(r instanceof Error)return void u(r);var c;try{c=i.apply(n,e)}catch(a){u(a)}var f=c instanceof Error;if(void 0!==c){null===c?c=t.state({}):f||(c=t.state(c)),r=c;for(var h in s)if(s.hasOwnProperty(h)){var v=s[h].subscriber;try{v.call(void 0,r)}catch(a){console.log("Error in subscriber: "+a),console.trace(a)}}f&&(s=[])}c instanceof Error?u(c):o(c)};return u=u.bind(this),new Promise(u)},f={actionCtx:c,actionFn:u};i[o]=a.bind(f)}}return i};t.stream=function(t){return new n(t)};var n=function(i){var r,e,s=new t({"in":function(t){return r=t,t}});return i(function(t){e=s["in"](t)}),this["in"]=function(n){s["in"](t.state(n))},this.disconnect=function(){e&&(e(),e=void 0)},this.subscribe=function(t){return s(t)},this.out=function(){return r},this.filter=function(i){var r=new t({filter:i});return s(function(t){r.filter(t)}),new n(r)},this.pipe=function(){return new n(s)},this.merge=function(i,r){var e,o;r=r||function(t,n){_.extendOwn({},t,n)};var u=new t({updateOurs:function(t){return e=t,r(e,o)},updateTheirs:function(t){return o=t,r(e,o)}});return i instanceof n?i.subscribe(function(t){u.updateTheirs(t)}):i(function(t){u.updateTheirs(t)}),s(function(t){u.updateOurs(t)}),new n(u)},this},i=function(n){var r=function(n){if(!_.isArray(n)&&!_.isArguments())throw new TypeError("Unable to initialize State.List from other data types than arrays.");var r=function(){return e.slice()},e=_.map(_.toArray(n),function(n){return t.state(n)});this.$Map=!1,this.$List=!0,this.type=function(){return"LIST"},this.get=function(t){return e[t]},this.size=function(){return e.length},this.add=function(t){return this.insert(this.size()+1,t)},this.remove=function(n){if(0==this.size()||n>this.size())return this;var i=r();return i.splice(n,1),t.state(i)},this.insert=function(n,i){var e=r(),i=t.state(i);return 0>n?n=0:n>this.size()&&(n=this.size()),e.splice(n,0,i),t.state(e)},this.push=function(t){return this.insert(this.size(),t)},this.pop=function(){return this.remove(this.size()-1)},this.shift=function(){return this.remove(0)},this.unshift=function(t){return this.insert(0,t)},this.toJS=function(){return _.map(e,function(t){return t instanceof i?t.toJS():t})},this.toJSON=function(t){return JSON.stringify(this.toJS(),void 0,t)}},e=function(n){if(!_.isObject(n))throw new TypeError("Unable to initialize State.Map from other data types than objects.");var r={};return _.each(Object.getOwnPropertyNames(n),function(i){r[i]=t.state(n[i])}),this.$Map=!0,this.$List=!1,this.type=function(){return"MAP"},this.get=function(t){return r[t]},this.put=function(n,i){if(void 0===i)return this.remove(n);var e=_.extend({},r);return e[n]=t.state(i),t.state(e)},this.remove=function(n){if(_.has(r,n)){var i=_.extendOwn({},r);return delete i[n],t.state(i)}return this},this.has=function(t){return _.has(r,t)},this.keys=function(){return _.keys(r)},this.merge=function(n){var e=t.state(n);if(!e instanceof i||!e.$Map)return this;var s=_.extendOwn({},r,n);return t.state(s)},this.toJS=function(){return _.chain(r).keys().reduce(function(t,n){var e=r[n];return e instanceof i&&(e=e.toJS()),t[n]=e,t},{}).value()},this.toJSON=function(t){return JSON.stringify(this.toJS(),void 0,t)},this};return n instanceof i?n:_.isArray(n)?(_.extend(this,new r(n)),this):_.isObject(n)?(_.extend(this,new e(n)),this):void 0};return t.state=function(t){return t instanceof i?t:_.isNumber(t)||_.isBoolean(t)||_.isString(t)||_.isNull(t)||_.isUndefined(t)?t:_.isFunction(t)?void 0:_.isArray(t)||_.isObject(t)?new i(t):void 0},t.subscribe=function(t,n){return t(n)},t});