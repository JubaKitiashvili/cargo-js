!function(t,n){"function"==typeof define&&define.amd?define(["cargo.Promise"],n):"object"==typeof exports?module.exports=n(require("cargo.Promise")):(t.cargo=t.cargo||{},t.cargo.Model=n(t.cargo.Promise))}(this,function(t){var n=function(e){"use strict";if(!t)throw new Error("cargo.Promise API is required.");var r=this,i=void 0,s=1,o={};r=function(n){var e=s++;if(n&&"function"==typeof n){o[e]={subscriber:n};var u=function(t){delete o[t]};return new t(function(t,e){if(void 0!==i&&!(i instanceof Error))try{n.call(void 0,i),t()}catch(r){console.log("Error in new subscriber: "+r),e()}}),u.bind(r,e)}};for(var u in e)if(e.hasOwnProperty(u)){var a=e[u];if("function"==typeof a){var c={state:function(){return void 0!=i?i:n.state({})},model:r},f=function(){for(var e=this.actionCtx,r=this.actionFn,s=[],u=0;u<arguments.length;u++)s.push(arguments[u]);var a=function(t,u){if(i instanceof Error)return void u(i);var a;try{a=r.apply(e,s)}catch(c){u(c)}var f=a instanceof Error;if(void 0!==a){null===a?a=n.state({}):f||(a=n.state(a)),i=a;for(var h in o)if(o.hasOwnProperty(h)){var v=o[h].subscriber;try{v.call(void 0,i)}catch(c){console.log("Error in subscriber: "+c),console.trace(c)}}f&&(o=[])}a instanceof Error?u(a):t(a)};return a=a.bind(this),new t(a)},h={actionCtx:c,actionFn:a};r[u]=f.bind(h)}}return r};n.stream=function(t){return new e(t)};var e=function(t){var r,i,s=new n({"in":function(t){return r=t,t}});return t(function(t){i=s["in"](t)}),this["in"]=function(t){s["in"](n.state(t))},this.disconnect=function(){i&&(i(),i=void 0)},this.subscribe=function(t){return s(t)},this.out=function(){return r},this.filter=function(t){var r=new n({filter:t});return s(function(t){r.filter(t)}),new e(r)},this.pipe=function(){return new e(s)},this.merge=function(t,r){var i,o;r=r||function(t,n){_.extendOwn({},t,n)};var u=new n({updateOurs:function(t){return i=t,r(i,o)},updateTheirs:function(t){return o=t,r(i,o)}});return t instanceof e?t.subscribe(function(t){u.updateTheirs(t)}):t(function(t){u.updateTheirs(t)}),s(function(t){u.updateOurs(t)}),new e(u)},this},r=function(t){var e=function(t){if(!_.isArray(t)&&!_.isArguments())throw new TypeError("Unable to initialize State.List from other data types than arrays.");var e=function(){return i.slice()},i=_.map(_.toArray(t),function(t){return n.state(t)});this.$Map=!1,this.$List=!0,this.type=function(){return"LIST"},this.get=function(t){return i[t]},this.size=function(){return i.length},this.add=function(t){return this.insert(this.size()+1,t)},this.remove=function(t){if(0==this.size()||t>this.size())return this;var r=e();return r.splice(t,1),n.state(r)},this.insert=function(t,r){var i=e(),r=n.state(r);return 0>t?t=0:t>this.size()&&(t=this.size()),i.splice(t,0,r),n.state(i)},this.push=function(t){return this.insert(this.size(),t)},this.pop=function(){return this.remove(0)},this.shift=function(){return this.remove(this.size()-1)},this.unshift=function(t){return this.insert(0,t)},this.toJS=function(){return _.map(i,function(t){return t instanceof r?t.toJS():t})}},i=function(t){if(!_.isObject(t))throw new TypeError("Unable to initialize State.Map from other data types than objects.");var e={},i=function(){return _.extendOwn({},e)};return _.each(Object.getOwnPropertyNames(t),function(r){e[r]=n.state(t[r])}),this.$Map=!0,this.$List=!1,this.type=function(){return"MAP"},this.get=function(t){return e[t]},this.put=function(t,r){if(void 0===r)return this.remove(t);var i=_.extend({},e);return i[t]=n.state(r),n.state(i)},this.remove=function(t){if(_.has(e,t)){var r=_.extendOwn({},e);return delete r[t],n.state(r)}return this},this.has=function(t){return _.has(e,t)},this.keys=function(){return _.keys(e)},this.merge=function(t){var i=n.state(t);if(!i instanceof r||!i.$Map)return this;var s=_.extendOwn({},e,t);return n.state(s)},this.deepMerge=function(t){if(t=n.state(t),!t||!t instanceof r||!t.$Map)throw new TypeError("Unable to deep merge state objects other than maps.");var e=i();return _.each(t.keys(),function(n){var i=t.get(n);if(i instanceof r&&i.$Map){var s=e[n];s&&s instanceof r&&s.$Map&&(i=s.deepMerge(i))}e[n]=i}),n.state(e)},this.toJS=function(){return _.chain(e).keys().reduce(function(t,n){var i=e[n];return i instanceof r&&(i=i.toJS()),t[n]=i,t},{}).value()},this};return _.isArray(t)?(_.extend(this,new e(t)),this):_.isObject(t)?(_.extend(this,new i(t)),this):void 0};return n.state=function(t){return t instanceof r?t:_.isNumber(t)||_.isBoolean(t)||_.isString(t)||_.isNull(t)||_.isUndefined(t)?t:_.isFunction(t)?void 0:_.isArray(t)||_.isObject(t)?new r(t):void 0},n.subscribe=function(t,n){return t(n)},n});