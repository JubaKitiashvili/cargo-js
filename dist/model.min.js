!function(t,n){"function"==typeof define&&define.amd?define([],n):"object"==typeof exports?module.exports=n():(t.cargo=t.cargo||{},t.cargo.Model=n())}(this,function(){var t=function(n){"use strict";if(!Promise)throw new Error("Promise API is required.");var i=this,e=void 0,r=1,s={};i=function(t){var n=r++;if(t&&"function"==typeof t){s[n]={subscriber:t};var o=function(t){delete s[t]};return new Promise(function(n,i){if(void 0!==e&&!(e instanceof Error))try{t.call(void 0,e),n()}catch(r){console.log("Error in new subscriber: "+r),i()}}),o.bind(i,n)}};for(var o in n)if(n.hasOwnProperty(o)){var u=n[o];if("function"==typeof u){var a={state:function(){return void 0!=e?e:t.state({})},model:i},c=function(){for(var n=this.actionCtx,i=this.actionFn,r=[],o=0;o<arguments.length;o++)r.push(arguments[o]);var u=function(o,u){if(e instanceof Error)return void u(e);var a;try{a=i.apply(n,r)}catch(c){u(c)}var f=a instanceof Error;if(void 0!==a){null===a?a=t.state({}):f||(a=t.state(a)),e=a;for(var h in s)if(s.hasOwnProperty(h)){var v=s[h].subscriber;try{v.call(void 0,e)}catch(c){console.log("Error in subscriber: "+c),console.trace(c)}}f&&(s=[])}a instanceof Error?u(a):o(a)};return u=u.bind(this),new Promise(u)},f={actionCtx:a,actionFn:u};i[o]=c.bind(f)}}return i};t.stream=function(t){return new n(t)};var n=function(i){var e,r,s=new t({"in":function(t){return e=t,t}});return i(function(t){r=s["in"](t)}),this["in"]=function(n){s["in"](t.state(n))},this.disconnect=function(){r&&(r(),r=void 0)},this.subscribe=function(t){return s(t)},this.out=function(){return e},this.filter=function(i){var e=new t({filter:i});return s(function(t){e.filter(t)}),new n(e)},this.pipe=function(){return new n(s)},this.merge=function(i,e){var r,o;e=e||function(t,n){_.extendOwn({},t,n)};var u=new t({updateOurs:function(t){return r=t,e(r,o)},updateTheirs:function(t){return o=t,e(r,o)}});return i instanceof n?i.subscribe(function(t){u.updateTheirs(t)}):i(function(t){u.updateTheirs(t)}),s(function(t){u.updateOurs(t)}),new n(u)},this},i=function(n){var e=function(n){if(!_.isArray(n)&&!_.isArguments())throw new TypeError("Unable to initialize State.List from other data types than arrays.");var e=function(){return r.slice()},r=_.map(_.toArray(n),function(n){return t.state(n)});this.$Map=!1,this.$List=!0,this.type=function(){return"LIST"},this.get=function(t){return r[t]},this.size=function(){return r.length},this.add=function(t){return this.insert(this.size()+1,t)},this.remove=function(n){if(0==this.size()||n>this.size())return this;var i=e();return i.splice(n,1),t.state(i)},this.insert=function(n,i){var r=e(),i=t.state(i);return 0>n?n=0:n>this.size()&&(n=this.size()),r.splice(n,0,i),t.state(r)},this.push=function(t){return this.insert(this.size(),t)},this.pop=function(){return this.remove(0)},this.shift=function(){return this.remove(this.size()-1)},this.unshift=function(t){return this.insert(0,t)},this.toJS=function(){return _.map(r,function(t){return t instanceof i?t.toJS():t})},this.toJSON=function(t){return JSON.stringify(this.toJS(),void 0,t)}},r=function(n){if(!_.isObject(n))throw new TypeError("Unable to initialize State.Map from other data types than objects.");var e={},r=function(){return _.extendOwn({},e)};return _.each(Object.getOwnPropertyNames(n),function(i){e[i]=t.state(n[i])}),this.$Map=!0,this.$List=!1,this.type=function(){return"MAP"},this.get=function(t){return e[t]},this.put=function(n,i){if(void 0===i)return this.remove(n);var r=_.extend({},e);return r[n]=t.state(i),t.state(r)},this.remove=function(n){if(_.has(e,n)){var i=_.extendOwn({},e);return delete i[n],t.state(i)}return this},this.has=function(t){return _.has(e,t)},this.keys=function(){return _.keys(e)},this.merge=function(n){var r=t.state(n);if(!r instanceof i||!r.$Map)return this;var s=_.extendOwn({},e,n);return t.state(s)},this.deepMerge=function(n){if(n=t.state(n),!n||!n instanceof i||!n.$Map)throw new TypeError("Unable to deep merge state objects other than maps.");var e=r();return _.each(n.keys(),function(t){var r=n.get(t);if(r instanceof i&&r.$Map){var s=e[t];s&&s instanceof i&&s.$Map&&(r=s.deepMerge(r))}e[t]=r}),t.state(e)},this.toJS=function(){return _.chain(e).keys().reduce(function(t,n){var r=e[n];return r instanceof i&&(r=r.toJS()),t[n]=r,t},{}).value()},this.toJSON=function(t){return JSON.stringify(this.toJS(),void 0,t)},this};return _.isArray(n)?(_.extend(this,new e(n)),this):_.isObject(n)?(_.extend(this,new r(n)),this):void 0};return t.state=function(t){return t instanceof i?t:_.isNumber(t)||_.isBoolean(t)||_.isString(t)||_.isNull(t)||_.isUndefined(t)?t:_.isFunction(t)?void 0:_.isArray(t)||_.isObject(t)?new i(t):void 0},t.subscribe=function(t,n){return t(n)},t});