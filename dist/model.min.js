!function(t,n){"function"==typeof define&&define.amd?define([],n):"object"==typeof exports?module.exports=n():(t.cargo=t.cargo||{},t.cargo.Model=n())}(this,function(){var t=function(n){"use strict";if(!Promise)throw new Error("Promise API is required.");var e=this,i=void 0,r=1,s={};e=function(t){var n=r++;if(t&&"function"==typeof t){s[n]={subscriber:t};var o=function(t){delete s[t]};return new Promise(function(n,e){if(void 0!==i&&!(i instanceof Error))try{t.call(void 0,i),n()}catch(r){console.log("Error in new subscriber: "+r),e()}}),o.bind(e,n)}};for(var o in n)if(n.hasOwnProperty(o)){var u=n[o];if("function"==typeof u){var a={state:function(){return void 0!=i?i:t.state({})},model:e},c=function(){for(var n=this.actionCtx,e=this.actionFn,r=[],o=0;o<arguments.length;o++)r.push(arguments[o]);var u=function(o,u){if(i instanceof Error)return void u(i);var a;try{a=e.apply(n,r)}catch(c){u(c)}var f=a instanceof Error;if(void 0!==a){null===a?a=t.state({}):f||(a=t.state(a)),i=a;for(var h in s)if(s.hasOwnProperty(h)){var v=s[h].subscriber;try{v.call(void 0,i)}catch(c){console.log("Error in subscriber: "+c),console.trace(c)}}f&&(s=[])}a instanceof Error?u(a):o(a)};return u=u.bind(this),new Promise(u)},f={actionCtx:a,actionFn:u};e[o]=c.bind(f)}}return e};t.stream=function(t){return new n(t)};var n=function(e){var i,r,s=new t({"in":function(t){return i=t,t}});return e(function(t){r=s["in"](t)}),this["in"]=function(n){s["in"](t.state(n))},this.disconnect=function(){r&&(r(),r=void 0)},this.subscribe=function(t){return s(t)},this.out=function(){return i},this.filter=function(e){var i=new t({filter:e});return s(function(t){i.filter(t)}),new n(i)},this.pipe=function(){return new n(s)},this.merge=function(e,i){var r,o;i=i||function(t,n){_.extendOwn({},t,n)};var u=new t({updateOurs:function(t){return r=t,i(r,o)},updateTheirs:function(t){return o=t,i(r,o)}});return e instanceof n?e.subscribe(function(t){u.updateTheirs(t)}):e(function(t){u.updateTheirs(t)}),s(function(t){u.updateOurs(t)}),new n(u)},this},e=function(n){var i=function(n){if(!_.isArray(n)&&!_.isArguments())throw new TypeError("Unable to initialize State.List from other data types than arrays.");var i=function(){return r.slice()},r=_.map(_.toArray(n),function(n){return t.state(n)});this.$Map=!1,this.$List=!0,this.type=function(){return"LIST"},this.get=function(t){return r[t]},this.size=function(){return r.length},this.add=function(t){return this.insert(this.size()+1,t)},this.remove=function(n){if(0==this.size()||n>this.size())return this;var e=i();return e.splice(n,1),t.state(e)},this.insert=function(n,e){var r=i(),e=t.state(e);return 0>n?n=0:n>this.size()&&(n=this.size()),r.splice(n,0,e),t.state(r)},this.push=function(t){return this.insert(this.size(),t)},this.pop=function(){return this.remove(0)},this.shift=function(){return this.remove(this.size()-1)},this.unshift=function(t){return this.insert(0,t)},this.toJS=function(){return _.map(r,function(t){return t instanceof e?t.toJS():t})}},r=function(n){if(!_.isObject(n))throw new TypeError("Unable to initialize State.Map from other data types than objects.");var i={},r=function(){return _.extendOwn({},i)};return _.each(Object.getOwnPropertyNames(n),function(e){i[e]=t.state(n[e])}),this.$Map=!0,this.$List=!1,this.type=function(){return"MAP"},this.get=function(t){return i[t]},this.put=function(n,e){if(void 0===e)return this.remove(n);var r=_.extend({},i);return r[n]=t.state(e),t.state(r)},this.remove=function(n){if(_.has(i,n)){var e=_.extendOwn({},i);return delete e[n],t.state(e)}return this},this.has=function(t){return _.has(i,t)},this.keys=function(){return _.keys(i)},this.merge=function(n){var r=t.state(n);if(!r instanceof e||!r.$Map)return this;var s=_.extendOwn({},i,n);return t.state(s)},this.deepMerge=function(n){if(n=t.state(n),!n||!n instanceof e||!n.$Map)throw new TypeError("Unable to deep merge state objects other than maps.");var i=r();return _.each(n.keys(),function(t){var r=n.get(t);if(r instanceof e&&r.$Map){var s=i[t];s&&s instanceof e&&s.$Map&&(r=s.deepMerge(r))}i[t]=r}),t.state(i)},this.toJS=function(){return _.chain(i).keys().reduce(function(t,n){var r=i[n];return r instanceof e&&(r=r.toJS()),t[n]=r,t},{}).value()},this};return _.isArray(n)?(_.extend(this,new i(n)),this):_.isObject(n)?(_.extend(this,new r(n)),this):void 0};return t.state=function(t){return t instanceof e?t:_.isNumber(t)||_.isBoolean(t)||_.isString(t)||_.isNull(t)||_.isUndefined(t)?t:_.isFunction(t)?void 0:_.isArray(t)||_.isObject(t)?new e(t):void 0},t.subscribe=function(t,n){return t(n)},t});