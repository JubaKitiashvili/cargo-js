!function(e,n){"function"==typeof define&&define.amd?define([],n):"object"==typeof exports?module.exports=n():(e.cargo=e.cargo||{},e.cargo.Promise=n())}(this,function(){"use strict";var e=function(n){var t=this,i="pending",o=void 0,r=[],f=function(e){return"undefined"==typeof window?void process.nextTick(e):void window.setTimeout(e,0)};t.state=function(){return{state:i,result:o}},t.resolve=function(e){var n=function(e){d(e)};f(n.bind(void 0,e))},t.reject=function(e){f(function(){u("rejected",e),l()})};var c=function(e){var n=["state","then","reject","resolve"];if(!e)return!1;for(var t=0;t<n.length;t++){var i=n[t];if(!e[i]||"function"!=typeof e[i])return!1}return!0},u=function(e,n){"pending"!=e&&"fulfilled"!=e&&"rejected"!=e||"pending"==i&&"pending"!=e&&(i=e,o=n)},l=function(){if("pending"!=i)for(;r.length>0;){var e,n=r.shift(),t=n.promise2;if("fulfilled"===i)if("function"==typeof n.onFulfilled)try{e=n.onFulfilled.call(void 0,o),t.resolve(e)}catch(f){t.reject(f)}else t.resolve(o);if("rejected"===i)if("function"==typeof n.onRejected)try{e=n.onRejected.call(void 0,o),t.resolve(e)}catch(c){t.reject(c)}else t.reject(o)}},d=function(e){if("pending"!=i)return void l();if(t===e)throw new TypeError("Promise cannot be resolved with itself as result.");if(c(e))"pending"!=e.state().state?(u(e.state().state,e.state().result),l()):e.then(function(e){t.resolve(e)},function(e){t.reject(e)});else if("function"==typeof e){var n=function(e){u("fulfilled",e),l()},o=function(e){u("rejected",e),l()};try{e.call(e,n,o)}catch(r){u("rejected",r)}}else u("fulfilled",e);l()};t.then=function(n,t){var o=new e("INSIDE PROMISE2");return r.push({onFulfilled:n,onRejected:t,promise2:o}),"pending"!=i&&f(function(){l()}),o},t["catch"]=function(n){var t=new e;return r.push({onFulfilled:void 0,onRejected:n,promise2:t}),"pending"!=i&&f(function(){l()}),t},t["finally"]=function(n){var t=new e;return r.push({onFulfilled:n,onRejected:n,promise2:t}),"pending"!=i&&f(function(){l()}),t},"function"==typeof n&&f(function(){d(n)})};return e.when=function(n){return n&&0!=n.length?new e(function(e,t){for(var i=[],o=n.length,r=0;r<n.length;r++){var f=function(n){i[this.idx]=n,o--,0==o&&e(i)};f=f.bind({idx:r}),n[r].then(f)["catch"](function(e){t(e)})}}):e.resolve([])},e.resolve=function(n){return new e(function(e){e(n)})},e.reject=function(n){return new e(function(e,t){t(n)})},e.all=e.when,e.race=function(n){return new e(function(e,t){for(var i=0;i<n.length;i++)n[i].then(function(n){e(n)})["catch"](function(e){t(e)})})},e});