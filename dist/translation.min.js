!function(e,n){"function"==typeof define&&define.amd?define(["cargo.Promise","cargo.Model","superagent","_"],n):"object"==typeof exports?module.exports=n(require("cargo.Promise"),require("cargo.Model"),require("superagent"),require("_")):(e.cargo=e.cargo||{},e.cargo.Translation=n(e.cargo.Promise,e.cargo.Model,e.superagent,e._))}(this,function(e,n,t,a){var r=function(r){"use strict";if(!n)throw new Error("cargo.Model API is required.");if(!e)throw new Error("cargo.Promise API is required.");if(!t)throw new Error("superagent is required. (https://github.com/visionmedia/superagent)");if(!a)throw new Error("underscore is required. (https://github.com/jashkenas/underscore)");if(!Handlebars)throw new Error("Handlebars is required. (https://github.com/wycats/handlebars.js/)");var s=n.state({});r=r||{};var i=r.baseURI;if(!i){var u=""+document.location,o=u.indexOf("#");-1!=o&&(u=u.substring(0,o)),u.match(/\.html/)&&(o=u.lastIndexOf("/"),-1!=o&&(u=u.substring(0,o+1))),i=u+"locales"}i=i.replace(/\/+$/,""),s=s.put("baseURI",i),s=s.put("namespaces",r.namespaces||(r.defaultNamespace?[r.defaultNamespace]:["translation"])),s=s.put("defaultLang",r.defaultLang||"en"),s=s.put("lang",s.get("defaultLang")),s=s.put("caching",r.caching||!0);var c=n.state({}),g=new n({loading:function(e,n){return{lang:e,namespaces:n.get("namespaces"),loading:!0}},finished:function(e){l.helpers.i18n&&l.unregisterHelper("i18n");var n=m(e);return l.registerHelper("i18n",function(){switch(arguments.length){case 0:case 1:return"";case 2:return n(arguments[0]);default:return n(arguments[0],arguments[1])}}),e.put("loading",!1)}}),l=r.handlebars||Handlebars.create();l.registerHelper("i18n",function(){switch(arguments.length){case 0:case 1:return"";case 2:return arguments[0];default:return arguments[1]+"."+arguments[0]}});var f=function(e,t){var a=e.get("lang");return n.state({lang:a,locales:[a,p(a)||a,e.get("defaultLang")],namespaces:e.get("namespaces"),translations:t})},d=function(e,n,t){if(s.get("caching")){var a={};a[e]={},a[e][n]=t,c=c.deepMerge(a)}},p=function(e){var n=new RegExp("(.+)_.+"),t=n.exec(e);return t?t[1]:void 0},h=function(n,a){if(c.has(n)&&c.get(n).get(a))return new e(function(e){e({lang:n,namespace:a,translation:c.get(n).get(a)})});var r=i+"/"+n+"/"+a+".json";return new e(function(e){t.get(r).end(function(t,r){return r&&r.ok?(d(n,a,r.body),void e({lang:n,namespace:a,translation:r.body})):void e({lang:n,namespace:a,translation:void 0})})})},m=function(e){var n=e.get("translations"),t=e.get("lang"),r=e.get("locales").get(1),s=e.get("locales").get(2),i=e.get("namespaces").get(0);return function(e,u){u=u||i;var o=a.chain([t,r,s]).uniq().reduce(function(t,a){return t||n.has(a)&&n.get(a).get(u)&&(t=n.get(a).get(u).get(e)),t},void 0).value();return o||e}},v=function(t){var r=t.get("lang"),s=t.get("namespaces").toJS(),i=a.uniq([r,p(r)||r,t.get("defaultLang")]),u=[];a.each(i,function(e){a.each(s,function(n){u.push(h(e,n))})}),g.loading(r,s);var o=e.when(u).then(function(r){var s=n.state({});a.each(r,function(e){var n={};n[e.lang]={},n[e.lang][e.namespace]=e.translation,s=s.deepMerge(n),d(e.lang,e.namespace,e.translation)});var i=f(t,s),u=m(i);return g.finished(i),e.resolve(u)});return o["catch"](function(e){console.log(e&&e.stack?e.stack:e)}),o};this.setDefaultLanguage=function(e){return s=s.put("defaultLang",e),v(s)},this.setNamespace=function(e){var n=a.isArray(e)?e:[e];return s=s.put("namespaces",n),v(s)},this.addNamespace=function(e){var n=s.get("namespaces").toJS();return a.contains(n,e)||n.push(e),s=s.put("namespaces",n),v(s)},this.getHandlebars=function(){return l},this.select=function(e){return s=s.put("lang",e),v(s)},this.subscribe=function(e){return g(e)}};return r});