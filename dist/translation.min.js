!function(e,n){"function"==typeof define&&define.amd?define(["cargo.Model","superagent","underscore"],n):"object"==typeof exports?module.exports=n(require("cargo.Model"),require("superagent"),require("underscore")):(e.cargo=e.cargo||{},e.cargo.Translation=n(e.cargo.Model,e.superagent,e.underscore))}(this,function(e,n,t){var r=function(r){"use strict";if(!e)throw new Error("cargo.Model API is required.");if(!Promise)throw new Error("Promise API is required.");if(!Promise.all)throw new Error("Promise API with support for Promise.all() is required. (https://github.com/tildeio/rsvp.js/)");if(!n)throw new Error("superagent is required. (https://github.com/visionmedia/superagent)");if(!t)throw new Error("underscore is required. (https://github.com/jashkenas/underscore)");var a=e.state({});r=r||{};var s=r.baseURI;if(!s){var i=""+document.location,o=i.indexOf("#");-1!=o&&(i=i.substring(0,o)),i.match(/\.html/)&&(o=i.lastIndexOf("/"),-1!=o&&(i=i.substring(0,o+1))),s=i+"locales"}s=s.replace(/\/+$/,""),a=a.put("baseURI",s),a=a.put("namespaces",r.namespaces||(r.defaultNamespace?[r.defaultNamespace]:["translation"])),a=a.put("defaultLang",r.defaultLang||"en"),a=a.put("lang",a.get("defaultLang")),a=a.put("caching",r.caching||!0);var u=function(e,n){return!n||a.get("namespaces").size()<=1?e:n+"."+e},c=e.state({}),g=function(e,n,t){if(a.get("caching")){var r={};r[e]={},r[e][n]=t,c=c.deepMerge(r)}},f=function(e){var n=new RegExp("(.+)_.+"),t=n.exec(e);return t?t[1]:void 0},l=function(e,t){if(c.has(e)&&c.get(e).get(t))return new Promise(function(n){n({lang:e,namespace:t,translation:c.get(e).get(t)})});var r=s+"/"+e+"/"+t+".json";return new Promise(function(a){n.get(r).end(function(n,r){return r&&r.ok?(g(e,t,r.body),void a({lang:e,namespace:t,translation:r.body})):void a({lang:e,namespace:t,translation:void 0})})})},p=function(e,n){var r=e.get("lang"),a=f(r)||r,s=e.get("defaultLang"),i=e.get("namespaces").get(0);return function(e,o){o=o||i;var u=t.chain([r,a,s]).uniq().reduce(function(t,r){return t||n.has(r)&&n.get(r).get(o)&&(t=n.get(r).get(o).get(e)),t},void 0).value();return u||e}},d=function(n){var r=n.get("lang"),a=n.get("namespaces").toJS(),s=t.uniq([r,f(r)||r,n.get("defaultLang")]),i=[];t.each(s,function(e){t.each(a,function(n){i.push(l(e,n))})});var o=Promise.all(i).then(function(r){var a=e.state({});return t.each(r,function(e){var n={};n[e.lang]={},n[e.lang][e.namespace]=e.translation,a=a.deepMerge(n),g(e.lang,e.namespace,e.translation)}),u=p(n,a),Promise.resolve(u)});return o["catch"](function(e){console.log(e&&e.stack?e.stack:e)}),o};this.setDefaultLanguage=function(e){return a=a.put("defaultLang",e),d(a)},this.setNamespace=function(e){var n=t.isArray(e)?e:[e];return a=a.put("namespaces",n),d(a)},this.addNamespace=function(e){var n=a.get("namespaces").toJS();return t.contains(n,e)||n.push(e),a=a.put("namespaces",n),d(a)},this.select=function(e){return a=a.put("lang",e),d(a)},this.translate=function(e,n){return u(e,n)},this.i18n=function(){return u},this.createHandlebarsHelper=function(){var e=t.bind(function(){var e,n,t=this.i18n();switch(arguments.length){case 0:case 1:return"";case 2:e=arguments[0],n=a.get("namespaces").get(0);break;case 3:e=arguments[0],n=arguments[1]}return t(e,n)},this);return e._t=t.bind(function(){return this.i18n()},this),e}};return r});