!function(e,t){"function"==typeof define&&define.amd?define(["cargo.Model","Promise","superagent","_"],t):"object"==typeof exports?module.exports=t(require("cargo.Model"),require("Promise"),require("superagent"),require("_")):(e.cargo=e.cargo||{},e.cargo.Translation=t(e.cargo.Model,e.Promise,e.superagent,e._))}(this,function(e,t,n,a){var r=function(r){"use strict";if(!e)throw new Error("cargo.Model API is required.");if(!t)throw new Error("Promise API is required.");if(!t.all)throw new Error("Promise API with support for Promise.all() is required. (https://github.com/tildeio/rsvp.js/)");if(!n)throw new Error("superagent is required. (https://github.com/visionmedia/superagent)");if(!a)throw new Error("underscore is required. (https://github.com/jashkenas/underscore)");var i=e.state({});r=r||{};var s=r.baseURI;if(!s){var u=""+document.location,o=u.indexOf("#");-1!=o&&(u=u.substring(0,o)),u.match(/\.html/)&&(o=u.lastIndexOf("/"),-1!=o&&(u=u.substring(0,o+1))),s=u+"locales"}s=s.replace(/\/+$/,""),i=i.put("baseURI",s),i=i.put("namespaces",r.namespaces||(r.defaultNamespace?[r.defaultNamespace]:["translation"])),i=i.put("defaultLang",r.defaultLang||"en"),i=i.put("lang",i.get("defaultLang")),i=i.put("caching",r.caching||!0);var c=function(e,t){return!t||i.get("namespaces").size()<=1?e:t+"."+e},g=e.state({}),f=function(e,t,n){if(i.get("caching")){var a={};a[e]={},a[e][t]=n,g=g.deepMerge(a)}},l=function(e){var t=new RegExp("(.+)_.+"),n=t.exec(e);return n?n[1]:void 0},p=function(e,a){if(g.has(e)&&g.get(e).get(a))return new t(function(t){t({lang:e,namespace:a,translation:g.get(e).get(a)})});var r=s+"/"+e+"/"+a+".json";return new t(function(t){n.get(r).end(function(n,r){return r&&r.ok?(f(e,a,r.body),void t({lang:e,namespace:a,translation:r.body})):void t({lang:e,namespace:a,translation:void 0})})})},d=function(e,t){var n=e.get("lang"),r=l(n)||n,i=e.get("defaultLang"),s=e.get("namespaces").get(0);return function(e,u){u=u||s;var o=a.chain([n,r,i]).uniq().reduce(function(n,a){return n||t.has(a)&&t.get(a).get(u)&&(n=t.get(a).get(u).get(e)),n},void 0).value();return o||e}},h=function(n){var r=n.get("lang"),i=n.get("namespaces").toJS(),s=a.uniq([r,l(r)||r,n.get("defaultLang")]),u=[];a.each(s,function(e){a.each(i,function(t){u.push(p(e,t))})});var o=t.all(u).then(function(r){var i=e.state({});return a.each(r,function(e){var t={};t[e.lang]={},t[e.lang][e.namespace]=e.translation,i=i.deepMerge(t),f(e.lang,e.namespace,e.translation)}),c=d(n,i),t.resolve(c)});return o["catch"](function(e){console.log(e&&e.stack?e.stack:e)}),o};this.setDefaultLanguage=function(e){return i=i.put("defaultLang",e),h(i)},this.setNamespace=function(e){var t=a.isArray(e)?e:[e];return i=i.put("namespaces",t),h(i)},this.addNamespace=function(e){var t=i.get("namespaces").toJS();return a.contains(t,e)||t.push(e),i=i.put("namespaces",t),h(i)},this.select=function(e){return i=i.put("lang",e),h(i)},this.translate=function(e,t){return c(e,t)},this.i18n=function(){return c},this.createHandlebarsHelper=function(){var e=a.bind(function(){var e,t,n=this.i18n();switch(arguments.length){case 0:case 1:return"";case 2:e=arguments[0],t=i.get("namespaces").get(0);break;case 3:e=arguments[0],t=arguments[1]}return n(e,t)},this);return e._t=a.bind(function(){return this.i18n()},this),e}};return r});