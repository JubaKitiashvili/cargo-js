!function(e,n){"function"==typeof define&&define.amd?define(["cargo.Model","superagent","underscore"],n):"object"==typeof exports?module.exports=n(require("cargo.Model"),require("superagent"),require("underscore")):(e.cargo=e.cargo||{},e.cargo.Translation=n(e.cargo.Model,e.superagent,e.underscore))}(this,function(e,n,a){var r=function(e){"use strict";if(!Promise)throw new Error("Promise API is required.");if(!Promise.all)throw new Error("Promise API with support for Promise.all() is required. (https://github.com/tildeio/rsvp.js/)");if(!n)throw new Error("superagent is required. (https://github.com/visionmedia/superagent)");if(!a)throw new Error("underscore is required. (https://github.com/jashkenas/underscore)");var r={};e=e||{};var t=e.baseURI;if(!t){var i=""+document.location,s=i.indexOf("#");-1!=s&&(i=i.substring(0,s)),i.match(/\.html/)&&(s=i.lastIndexOf("/"),-1!=s&&(i=i.substring(0,s+1))),t=i+"locales"}t=t.replace(/\/+$/,""),r.baseURI=t,r.namespaces=e.namespaces||(e.defaultNamespace?[e.defaultNamespace]:["translation"]),r.defaultLang=e.defaultLang||"en",r.lang=r.defaultLang,r.caching=e.caching||!0;var o=function(e,n){return!n||r.namespaces.length<=1?e:n+"."+e},c={},u=function(e,n,a){if(r.caching){c[e]=c[e]||{},c[e][n]=a}},l=function(e){var n=new RegExp("(.+)_.+"),a=n.exec(e);return a?a[1]:void 0},f=function(e,a){if(c[e]&&c[e][a])return new Promise(function(n){n({lang:e,namespace:a,translation:c[e][a]})});var r=t+"/"+e+"/"+a+".json";return new Promise(function(t){n.get(r).end(function(n,r){return r&&r.ok?(u(e,a,r.body),void t({lang:e,namespace:a,translation:r.body})):void t({lang:e,namespace:a,translation:void 0})})})},d=function(e,n){var r=e.lang,t=l(r)||r,i=e.defaultLang,s=e.namespaces[0];return function(e,o){o=o||s;var c=a.chain([r,t,i]).uniq().reduce(function(a,r){return a||n[r]&&n[r][o]&&(a=n[r][o][e]),a},void 0).value();return c||e}},g=function(e){var n=e.lang,r=e.namespaces,t=a.uniq([n,l(n)||n,e.defaultLang]),i=[];a.each(t,function(e){a.each(r,function(n){i.push(f(e,n))})});var s=Promise.all(i).then(function(n){var r={};return a.each(n,function(e){r[e.lang]=r[e.lang]||{},r[e.lang][e.namespace]=e.translation,u(e.lang,e.namespace,e.translation)}),o=d(e,r),Promise.resolve(o)});return s["catch"](function(e){console.log(e&&e.stack?e.stack:e)}),s};this.setDefaultLanguage=function(e){return r.defaultLang=e,g(r)},this.setNamespace=function(e){var n=a.isArray(e)?e:[e];return r.namespaces=n,g(r)},this.addNamespace=function(e){return a.contains(r.namespaces,e)||r.namespaces.push(e),g(r)},this.select=function(e){return r.lang=e,g(r)},this.translate=function(e,n){return o(e,n)},this.i18n=function(){return o},this.createHandlebarsHelper=function(){var e=a.bind(function(){var e,n,a=this.i18n();switch(arguments.length){case 0:case 1:return"";case 2:e=arguments[0],n=r.namespaces[0];break;case 3:e=arguments[0],n=arguments[1]}return a(e,n)},this);return e._t=a.bind(function(){return this.i18n()},this),e}};return r});