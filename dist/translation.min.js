!function(e,n){"function"==typeof define&&define.amd?define(["cargo.Promise","cargo.Model","superagent","_"],n):"object"==typeof exports?module.exports=n(require("cargo.Promise"),require("cargo.Model"),require("superagent"),require("_")):(e.cargo=e.cargo||{},e.cargo.Translation=n(e.cargo.Promise,e.cargo.Model,e.superagent,e._))}(this,function(e,n,r,a){var t=function(t){"use strict";if(!n)throw new Error("cargo.Model API is required.");if(!e)throw new Error("cargo.Promise API is required.");if(!r)throw new Error("superagent is required. (https://github.com/visionmedia/superagent)");if(!a)throw new Error("underscore is required. (https://github.com/jashkenas/underscore)");var o={},i={},u={},s=function(e){var n=new RegExp("(.+)_.+"),r=n.exec(e);return r?r[1]:void 0},c=function(n){var a=i.baseURI+"/"+n+"/"+i.namespace+".json";return new e(function(e){r.get(a).end(function(r,a){if(a&&a.ok)return void e({lang:n,translation:a.body});var t=s(n);return t?void c(t).then(function(r){r.lang=n,e(r)})["catch"](function(){e({lang:n,translation:void 0})}):void e({lang:n,translation:void 0})})})};if(t=t||{},i.namespace=t.namespace||"translation",t.baseURI)i.baseURI=t.baseURI;else{var l=""+document.location,d=l.indexOf("#");-1!=d&&(l=l.substring(0,d)),l.match(/\.html/)&&(d=l.lastIndexOf("/"),-1!=d&&(l=l.substring(0,d+1))),i.baseURI=l+"locales"}i.baseURI=i.baseURI.replace(/\/+$/,""),i.defaultLang=t.defaultLang||"en";var g=t.languages||[];g.push(i.defaultLang);var f=a.chain(g).uniq(!0).map(function(e){return e.toLowerCase()}).map(function(e){return c(e)}).value();return i.loading=e.when(f).then(function(e){a.each(e,function(e){if(e.translation){u[e.lang]=e.translation;var n=s(e.lang);n&&!u[n]&&(u[n]=u[e.lang])}}),delete i.loading})["catch"](function(e){console.log("Loading translations for namespace '"+i.namespace+"' failed: "+e)}),o.select=function(e){var n=this.model;if(i.loading)return void i.loading.then(function(){n.select(e)});e=e||i.defaultLang;var r=a.chain([e,s(e),i.defaultLang]).reject(function(e){return void 0==e}).uniq().reduce(function(e,n){return e||u[n]},null).value();return r||(r={}),r},new n(o)};return t});