!function(e,n){"function"==typeof define&&define.amd?define(["cargo.Promise","cargo.Model","superagent","_"],n):"object"==typeof exports?module.exports=n(require("cargo.Promise"),require("cargo.Model"),require("superagent"),require("_")):(e.cargo=e.cargo||{},e.cargo.Translation=n(e.cargo.Promise,e.cargo.Model,e.superagent,e._))}(this,function(e,n,t,a){var r=function(r){"use strict";if(!n)throw new Error("cargo.Model API is required.");if(!e)throw new Error("cargo.Promise API is required.");if(!t)throw new Error("superagent is required. (https://github.com/visionmedia/superagent)");if(!a)throw new Error("underscore is required. (https://github.com/jashkenas/underscore)");if(!Handlebars)throw new Error("Handlebars is required. (https://github.com/wycats/handlebars.js/)");var s=n.state({});r=r||{};var i=r.baseURI;if(!i){var u=""+document.location,o=u.indexOf("#");-1!=o&&(u=u.substring(0,o)),u.match(/\.html/)&&(o=u.lastIndexOf("/"),-1!=o&&(u=u.substring(0,o+1))),i=u+"locales"}i=i.replace(/\/+$/,""),s=s.put("baseURI",i),s=s.put("namespaces",r.namespaces||(r.defaultNamespace?[r.defaultNamespace]:["translation"])),s=s.put("defaultLang",r.defaultLang||"en"),s=s.put("lang",s.get("defaultLang")),s=s.put("caching",r.caching||!0);var c=function(e,n){return!n||s.get("namespaces").size()<=1?e:n+"."+e},g=n.state({}),f=function(e,n,t){if(s.get("caching")){var a={};a[e]={},a[e][n]=t,g=g.deepMerge(a)}},l=function(e){var n=new RegExp("(.+)_.+"),t=n.exec(e);return t?t[1]:void 0},p=function(n,a){if(g.has(n)&&g.get(n).get(a))return new e(function(e){e({lang:n,namespace:a,translation:g.get(n).get(a)})});var r=i+"/"+n+"/"+a+".json";return new e(function(e){t.get(r).end(function(t,r){return r&&r.ok?(f(n,a,r.body),void e({lang:n,namespace:a,translation:r.body})):void e({lang:n,namespace:a,translation:void 0})})})},d=function(e,n){var t=e.get("lang"),r=l(t)||t,s=e.get("defaultLang"),i=e.get("namespaces").get(0);return function(e,u){u=u||i;var o=a.chain([t,r,s]).uniq().reduce(function(t,a){return t||n.has(a)&&n.get(a).get(u)&&(t=n.get(a).get(u).get(e)),t},void 0).value();return o||e}},h=function(t){var r=t.get("lang"),s=t.get("namespaces").toJS(),i=a.uniq([r,l(r)||r,t.get("defaultLang")]),u=[];a.each(i,function(e){a.each(s,function(n){u.push(p(e,n))})});var o=e.when(u).then(function(r){var s=n.state({});return a.each(r,function(e){var n={};n[e.lang]={},n[e.lang][e.namespace]=e.translation,s=s.deepMerge(n),f(e.lang,e.namespace,e.translation)}),c=d(t,s),e.resolve(c)});return o["catch"](function(e){console.log(e&&e.stack?e.stack:e)}),o};this.setDefaultLanguage=function(e){return s=s.put("defaultLang",e),h(s)},this.setNamespace=function(e){var n=a.isArray(e)?e:[e];return s=s.put("namespaces",n),h(s)},this.addNamespace=function(e){var n=s.get("namespaces").toJS();return a.contains(n,e)||n.push(e),s=s.put("namespaces",n),h(s)},this.select=function(e){return s=s.put("lang",e),h(s)},this.translate=function(e,n){return c(e,n)},this.i18n=function(){return c},this.createHandlebarsHelper=function(){var e=this.i18n(),n=function(){var n,t;switch(arguments.length){case 0:case 1:return"";case 2:n=arguments[0],t=s.get("namespaces").get(0);break;case 3:n=arguments[0],t=arguments[1]}return e(n,t)};return n._t=e,n}};return r});