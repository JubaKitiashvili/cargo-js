!function(e,n){"function"==typeof define&&define.amd?define(["cargo.Promise","cargo.Model","superagent","_"],n):"object"==typeof exports?module.exports=n(require("cargo.Promise"),require("cargo.Model"),require("superagent"),require("_")):(e.cargo=e.cargo||{},e.cargo.Translation=n(e.cargo.Promise,e.cargo.Model,e.superagent,e._))}(this,function(e,n,r,t){var a=function(a,i){"use strict";if(!n)throw new Error("cargo.Model API is required.");if(!e)throw new Error("cargo.Promise API is required.");if(!r)throw new Error("superagent is required. (https://github.com/visionmedia/superagent)");if(!t)throw new Error("underscore is required. (https://github.com/jashkenas/underscore)");if(!Handlebars)throw new Error("Handlebars is required. (https://github.com/wycats/handlebars.js/)");if(!a){var o=""+document.location,s=o.indexOf("#");-1!=s&&(o=o.substring(0,s)),o.match(/\.html/)&&(s=o.lastIndexOf("/"),-1!=s&&(o=o.substring(0,s+1))),a=o+"locales"}a=a.replace(/\/+$/,""),i=i||["translation"];var c="en",u="en",d="en",f=void 0,g=n.state({}),h=new n({update:function(){return{lang:d,locales:[d,u,c],namespaces:i,translations:g,loading:void 0!==f}}}),l=Handlebars.create();l.registerHelper("i18n",function(){switch(arguments.length){case 0:case 1:return"";case 2:return m(arguments[0]);default:return m(arguments[0],arguments[1])}});var p=function(e){var n=new RegExp("(.+)_.+"),r=n.exec(e);return r?r[1]:void 0},v=function(n,t){var i=a+"/"+n+"/"+t+".json";return new e(function(e){r.get(i).end(function(r,a){return a&&a.ok?void e({lang:n,namespace:t,translation:a.body}):void e({lang:n,namespace:t,translation:void 0})})})},m=function(e,n){void 0===n&&(n=i[0]);var r=t.chain([d,u,c]).uniq().reduce(function(r,t){return r||g.has(t)&&g.get(t).get(n)&&(r=g.get(t).get(n).get(e)),r},void 0).value();return r||e};this.setDefaultLanguage=function(e){return c=e,this.select(d)},this.setNamespace=function(e){return i=t.isArray(e)?e:[e],this.select(d)},this.addNamespace=function(e){return t.contains(i,e)||i.push(e),this.select(d)},this.getHandlebars=function(){return l},this.select=function(n){var r=this;if(f)return f.then(function(e){r.select(n)});var a=[],o=t.uniq([n,p(n)||n,c]);return t.each(g.keys(),function(e){t.contains(o,e)||(g=g.remove(e))}),t.each(o,function(e){t.each(i,function(n){g.has(e)&&g.get(e).has(n)||a.push(v(e,n))})}),f=e.when(a).then(function(e){return t.each(e,function(e){var n={};n[e.lang]={},n[e.lang][e.namespace]=e.translation,g=g.deepMerge(n)}),f=void 0,d=n,u=p(n)||d,h.update(),m})["catch"](function(e){console.log(e&&e.stack?e.stack:e)}),h.update(),new e(function(e){var n=h(function(r){r.get("loading")||(n(),e(m))})})},this.subscribe=function(e){return h(e)},this.asStream=function(){return n.stream(h)}};return a});