<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Component.js - Test file.</title>
    <link rel="shortcut icon" type="image/png" href="../../bower_components/jasmine-core/images/jasmine_favicon.png">
    <link rel="stylesheet" type="text/css" href="../../bower_components/jasmine-core/lib/jasmine-core/jasmine.css">

    <script type="text/javascript" src="../../bower_components/jasmine-core/lib/jasmine-core/jasmine.js"></script>
    <script type="text/javascript" src="../../bower_components/jasmine-core/lib/jasmine-core/jasmine-html.js"></script>
    <script type="text/javascript" src="../../bower_components/jasmine-core/lib/jasmine-core/boot.js"></script>
    <script type="text/javascript" src="../../bower_components/jquery/dist/jquery.js"></script>
    <script type="text/javascript" src="../../dist/model.js"></script>
    <script type="text/javascript" src="../../dist/dependencies/rsvp.js"></script>
    <script type="text/javascript" src="../../dist/dependencies/underscore.js"></script>
    <script type="text/javascript" src="../../dist/dependencies/superagent.js"></script>
    <script type="text/javascript" src="../../dist/dependencies/js.cookie.js"></script>
    <script type="text/javascript" src="../../dist/dependencies/handlebars.js"></script>
</head>
<body>

<nav id="test"/>
<script type="text/javascript">
    window.Model = cargo.Model;
    window.Promise = RSVP.Promise;
</script>
<script type="text/javascript" src="Translation.js"></script>
<script type="text/javascript">

    describe("Constructor", function () {
        it("returning a translation instance.", function () {
            var trans = new Translation();
            expect(trans).toBeDefined();
            expect(trans instanceof Translation).toBeTruthy();
        });
    });

    describe("Loading", function () {
        it(" the default translation without any options.", function (done) {
            var trans = new Translation();
            trans.select('en').then(function(t) {
                expect(t('GREETING')).toBe("Hello World!");
                expect(t('READY')).toBe("ready");
                done();
            });
        });

        it(" the default translation when selecting an unknown language.", function (done) {
            var trans = new Translation();
            trans.select('fr').then(function(t) {
                expect(t('GREETING')).toBe("Hello World!");
                expect(t('READY')).toBe("ready");
                done();
            });
        });

        it(" no translation when selecting a non-existent namespace.", function (done) {
            var trans = new Translation();
            trans.addNamespace('missing');
            trans.select('en').then(function(t) {
                expect(t('GREETING', 'missing')).toEqual('GREETING');
                done();
            });
        });

        it(" no translation when selecting a non-existent base URI.", function (done) {
            var trans = new Translation({ baseURI: 'missing', namespaces: ['missing']});
            trans.select('en').then(function(t) {
                var p = t('GREETING');
                expect(t('GREETING')).toEqual('GREETING');
                done();
            });
        });

    });

    describe("Selecting ", function() {

        it("a language returns a promise which fulfills with a translation function when loading finishes.", function(done) {
            var trans = new Translation();
            var p = trans.select('en');
            expect(p instanceof Promise).toBeTruthy();
            p.then(function(t) {
                expect(typeof t).toEqual('function');
                expect(t('GREETING')).toEqual('Hello World!');
                done();
            }).catch(function(e) {
                console.log(e && e.stack ? e.stack : e);
            });
        });

        it("the same language again returns a promise which fulfills with a translation function.", function(done) {
            var trans = new Translation();
            var p = trans.select('en').then(function(t) {
                trans.select('en').then(function(t) {
                    expect(typeof t).toEqual('function');
                    expect(t('GREETING')).toEqual('Hello World!');
                    done();
                });
            });
        });

        it("another language returns a promise which fulfills with a translation function for the selected language.", function(done) {
            var trans = new Translation();
            var p = trans.select('en').then(function(t) {
                trans.select('de').then(function(t) {
                    expect(typeof t).toEqual('function');
                    expect(t('GREETING')).toEqual('Hallo Welt!');
                    done();
                });
            });
        });

        it("a language translates correctly.", function(done) {
            var trans = new Translation();
            var p = trans.select('de');
            expect(p instanceof Promise).toBeTruthy();
            p.then(function(t) {
                expect(typeof t).toEqual('function');
                expect(t('GREETING')).toEqual('Hallo Welt!');
                done();
            }).catch(function(e) {
                console.log(e && e.stack ? e.stack : e);
            });
        });

        it("a non-existent language translates to the default language.", function(done) {
            var trans = new Translation();
            var p = trans.select('fr');
            expect(p instanceof Promise).toBeTruthy();
            p.then(function(t) {
                expect(typeof t).toEqual('function');
                expect(t('GREETING')).toEqual('Hello World!');
                done();
            }).catch(function(e) {
                console.log(e && e.stack ? e.stack : e);
                done();
            });
        });

        it("a non-existent locale translates to the parent language if it exists (part 1).", function(done) {
            var trans = new Translation();
            var p = trans.select('en_US');
            expect(p instanceof Promise).toBeTruthy();
            p.then(function(t) {
                expect(typeof t).toEqual('function');
                expect(t('GREETING')).toEqual('Hello World!');
                done();
            }).catch(function(e) {
                console.log(e && e.stack ? e.stack : e);
            });
        });

        it("a non-existent locale translates to the parent language if it exists (part 2).", function(done) {
            var trans = new Translation();
            var p = trans.select('de_AT');
            expect(p instanceof Promise).toBeTruthy();
            p.then(function(t) {
                expect(typeof t).toEqual('function');
                expect(t('GREETING')).toEqual('Hallo Welt!');
                done();
            }).catch(function(e) {
                console.log(e && e.stack ? e.stack : e);
            });
        });

        it("a language after selecting another language returns two independent translation functions (part 1).", function(done) {
            var trans = new Translation();
            var loaded = 0;
            trans.select('en').then(function(t) {
                expect(typeof t).toEqual('function');
                expect(t('GREETING')).toEqual('Hello World!');
                loaded++;
                if ( loaded == 2 ) {
                    done();
                }
            });
            trans.select('de').then(function(t) {
                expect(typeof t).toEqual('function');
                expect(t('GREETING')).toEqual('Hallo Welt!');
                loaded++;
                if ( loaded == 2 ) {
                    done();
                }
            });
        });

        it("a language after selecting another language returns two independent translation functions (part 2).", function(done) {
            var trans = new Translation();
            var t_en;
            trans.select('en').then(function(t) {
                t_en = t;
                trans.select('de').then(function (t) {
                    expect(typeof t).toEqual('function');
                    expect(t('GREETING')).toEqual('Hallo Welt!');
                    expect(typeof t_en).toEqual('function');
                    expect(t_en('GREETING')).toEqual('Hello World!');
                    done();
                });
            });
        });

    });

    describe('Handlebars support from Translation', function() {

        it("provides an i18n helper", function (done) {
            var trans = new Translation();
            var handlebars = Handlebars.create();
            var template = handlebars.compile("{{i18n 'GREETING'}}");
            var helper = trans.createHandlebarsHelper();
            expect(typeof helper).toEqual('function');
            handlebars.registerHelper('i18n', helper);
            var rendered = template({});
            expect(rendered).toEqual('GREETING');
            done();
        });

        it("provides an i18n helper that replaces keys with translation.", function (done) {
            var trans = new Translation();
            trans.select('en').then(function() {
                var handlebars = Handlebars.create();
                var template = handlebars.compile("{{i18n 'GREETING'}}");
                var helper = trans.createHandlebarsHelper();
                expect(typeof helper).toEqual('function');
                handlebars.registerHelper('i18n', helper);
                var rendered = template({});
                expect(rendered).toEqual('Hello World!');
                done();
            });
        });

        it("provides an i18n helper that replaces keys with translation after selecting a language.", function (done) {
            var trans = new Translation();
            trans.select('de').then(function() {
                var handlebars = Handlebars.create();
                var template = handlebars.compile("{{i18n 'GREETING'}}");
                var helper = trans.createHandlebarsHelper();
                expect(typeof helper).toEqual('function');
                handlebars.registerHelper('i18n', helper);
                var rendered = template({});
                expect(rendered).toEqual('Hallo Welt!');
                done();
            });
        });

        it("provides an i18n helper that replaces keys with translation after re-selecting a different language.", function (done) {
            var trans = new Translation();
            trans.select('en').then(function () {
                trans.select('de').then(function () {
                    var handlebars = Handlebars.create();
                    var template = handlebars.compile("{{i18n 'GREETING'}}");
                    var helper = trans.createHandlebarsHelper();
                    expect(typeof helper).toEqual('function');
                    handlebars.registerHelper('i18n', helper);
                    var rendered = template({});
                    expect(rendered).toEqual('Hallo Welt!');
                    done();
                });
            });
        });

        it("provides an i18n helper that replaces keys from namespaces with translation after re-selecting a different language.", function (done) {
            var trans = new Translation();
            trans.select('en').then(function () {
                trans.select('de').then(function () {
                    var handlebars = Handlebars.create();
                    var template = handlebars.compile("{{i18n 'GREETING' 'translation'}}");
                    var helper = trans.createHandlebarsHelper();
                    expect(typeof helper).toEqual('function');
                    handlebars.registerHelper('i18n', helper);
                    var rendered = template({});
                    expect(rendered).toEqual('Hallo Welt!');
                    done();
                });
            });
        });

    })


</script>


</body>
</html>
